<html lang="en-US">

<head>
<title>Web Chat: User Direct Line Token</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!--
    This CDN points to the latest official release of Web Chat. If you need to test against Web Chat's latest bits, please refer to pointing to Web Chat's MyGet feed:
    https://github.com/microsoft/BotFramework-WebChat#how-to-test-with-web-chats-latest-bits
  -->
<script crossorigin="anonymous" src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
<script src="https://alcdn.msauth.net/lib/1.3.2/js/msal.min.js"></script>
<script src="https://unpkg.com/simple-update-in/dist/simple-update-in.production.min.js"></script>

<style>
   html,

   body {
      background-color: #e9f3f3;
      height: 100%;
      max-width: 800px;
      margin: 0 auto;
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
    }

    #webchat {
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      height: 60%;
      margin: 30px 50px 75px 50px;
      max-width: 480px;
      min-width: 500px;
    }

</style>
</head>

<body>

<h2> <img src="\images\web-chat.png" alt="web chat icon"/> Web Chat client</h2>

This page contains a minimally customized Web Chat client which allows user to interact with a bot.<br/>
It creates a token based on the bot Direct Line secret.
This is <span style="background-color:yellow">important to avoid security breaches</span>. <br/>

<hr style="border-top: 3px dashed blue;"/>

<h3>Talk to the bot</h3>


<div style="width:50%; border: 2px solid #73AD21;"  id="webchat" role="main"></div>


<script>
async function exchangeToken(resourceUri) {
let userinapp = myMSALObj.getAccount();
if (userinapp) {
   let requestObj = {
     scopes: [resourceUri, "openid", "profile"],
     //authority: "https://login.microsoftonline.com/c65a3ea6-0f7c-400b-8934-5a6dc1705645",
   };
   tokenResponse=await myMSALObj.acquireTokenSilent(requestObj)
   return tokenResponse.accessToken;
   /*return myMSALObj.acquireTokenSilent(requestObj)
     .then(function (tokenResponse) {
       console.log(tokenResponse);
       return tokenResponse.accessToken;
       })
       .catch(function (error) {
         console.log(error);
       });*/
  }
  else {
    console.log("PASSS")
    return Promise.resolve(null);
    }

}


  // Azure AD identity provider app ID. Used to authenticate the bot's users.
  //const AAD_APP_ID = '33384254-e614-4099-8480-515bb1b9ea2d';
  const AAD_APP_ID = 'fa89db60-61fd-4146-a22d-d96a503ad21f';

  // Azure AD app redirect URI after the auth flow.
  // Add it to the Azure AD identity provider, too.
  const AAD_REDIRECT_URI = 'https://josecruz9807.github.io';

  const styleOptions = {
      bubbleBackground: 'rgba(0, 0, 255, .1)',
      bubbleFromUserBackground: 'rgba(0, 255, 0, .1)'
  };

  // Calls backend API to get Direct Line token
  async function getDirectLineToken(idToken) {
    const res = await fetch('https://webapp-api-chtecbot.azurewebsites.net/api/directLineToken', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer '+idToken
      },
      //body: JSON.stringify({ idToken: idToken }),
    });

    if (!res.ok) {
      throw new Error(`Failed to get Direct Line token due to ${res.status}`);
    }

    return await res.json();
  }

  // Create MSAL object

  const myMSALObj = new Msal.UserAgentApplication({
    auth: {
      clientId: AAD_APP_ID,
      redirectUri: AAD_REDIRECT_URI,
      authority: "https://login.microsoftonline.com/c65a3ea6-0f7c-400b-8934-5a6dc1705645",
      scopes: ["api://fa89db60-61fd-4146-a22d-d96a503ad21f/access_as_user"]
    }
  });

  (async function main() {
    const userAccount = myMSALObj.getAccount();
    if (userAccount) {
      console.log(`User is already signed in: ${userAccount.userName}`);

      // There are edge cases where acquiring a token silently can fail
      // For example, a user may have revoked consent for the application
      // In a production app, you should catch and handle errors from the ssoSilent call
      console.log(`Attempting to silently acquire ID token...`);
      const ssoSilentResponse = await myMSALObj.ssoSilent({ loginHint: userAccount.userName });
     //console.log(ssoSilentResponse);
      const idToken = ssoSilentResponse.idToken.rawIdToken;
      console.log(`Successfully acquired ID token!`);

      console.log(`Attempting to get Direct Line token...`);
      var AAD_accesToken=await exchangeToken( "api://fa89db60-61fd-4146-a22d-d96a503ad21f/access_as_user");
      console.log(AAD_accesToken)
      const directLineTokenResponse = await getDirectLineToken(AAD_accesToken);
      console.log(`Got Direct Line token (user ID is ${directLineTokenResponse.userId})`);
      
      
      const store = WebChat.createStore(
        {},
        ({ dispatch }) => next => action => {
          const event = new Event('webchatincomingactivity');
          event.data = action;//.payload.activity;
          window.dispatchEvent(event);
          let displayOrNot= true;
          if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
              dispatch({
                  type: 'WEB_CHAT/SEND_EVENT',
                  payload: {
                      name: 'startConversation',
                      type: 'event',
                      channelData: {
                          token:AAD_accesToken
                      }
                  }
              });
              return next(action);
          }
          if (action.type === 'DIRECT_LINE/POST_ACTIVITY') {
              // Mocking data to be sent
              const userId = 'xyz789';
              const payloadUserContext = action.payload;
              
              action = window.simpleUpdateIn(
                action,
                ['payload', 'activity', 'channelData'],
                () => ({
                  token:AAD_accesToken
                })
              )
            }
          return next(action);
          
        });
      
      const  dirLine= window.WebChat.createDirectLine({ token: directLineTokenResponse.token });

      const dirToken=dirLine.token;
      window.WebChat.renderWebChat(
        {

          directLine: dirLine,
          store,
          styleOptions
        },
        document.getElementById('webchat'),
      );

      window.addEventListener('webchatincomingactivity', ({ data }) => {
        console.log(`Received an activity of type "${data.type}":`);
        console.log(data);
      });

    } else {
      console.log(`User is not signed in. Attempting to log in via redirect...`);
      myMSALObj.loginRedirect();
    }
  })().catch(err => console.error(err));
</script>
</body>

</html>